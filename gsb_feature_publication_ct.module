<?php
/**
 * @file
 * Code for the GSB Feature Publication Content Type feature.
 */

include_once 'gsb_feature_publication_ct.features.inc';


/**
 * Implements hook_form_FORM_ID_alter() for publication node edit form.
 */
function gsb_feature_publication_ct_form_publication_node_form_alter(&$form, &$form_state) {
  $language = $form['language']['#value'];

  if (!empty($form['field_authors'][$language])) {
    foreach (element_children($form['field_authors'][$language]) as $index) {
      if (is_integer($index)) {

        $form['field_authors'][$language][$index]['field_person_fac_single_ref']['#states'] = array(
          'visible' => array(
            ':input[name="field_authors[' . $language . '][' . $index . '][field_person_fac_or_other][' . $language . ']"]' => array(
              array('value' => 'UseEntityReference'),
            ),
          ),
        );

        $form['field_authors'][$language][$index]['field_first_name']['#states'] = array(
          'visible' => array(
            ':input[name="field_authors[' . $language . '][' . $index . '][field_person_fac_or_other][' . $language . ']"]' => array(
              array('value' => 'Other'),
            ),
          ),
        );

        $form['field_authors'][$language][$index]['field_last_name']['#states'] = array(
          'visible' => array(
            ':input[name="field_authors[' . $language . '][' . $index . '][field_person_fac_or_other][' . $language . ']"]' => array(
              array('value' => 'Other'),
            ),
          ),
        );

        // remove "n/a" as an option for the fac_or_other
        unset($form['field_authors'][$language][$index]['field_person_fac_or_other'][$language]['#options']['_none']);
      }
    }
  }

  // Add required field markers. The actual field validation is done in validate callback.
  if (!empty($form['field_first_name'][$language])) {
    $form['field_first_name'][$language][0]['value']['#title'] .= " " . theme('form_required_marker');
  }

  if (!empty($form['field_last_name'][$language])) {
    $form['field_last_name'][$language][0]['value']['#title'] .= " " . theme('form_required_marker');
  }

  if (!empty($form['field_program_single'][$language])) {
    $form['field_program_single'][$language]['#title'] .= " " . theme('form_required_marker');
  }

  if (!empty($form['field_year'][$language])) {
    $form['field_year'][$language][0]['#title'] .= " " . theme('form_required_marker');
  }

  // Hide alumni fields if the alumni checkbox is not checked.
  $form['field_year']['#states']['invisible'][':input[name="field_alumni_story[' . $language . ']"]'] = array(
    array('checked' => FALSE),
  );

  $form['field_program_single']['#states']['invisible'][':input[name="field_alumni_story[' . $language . ']"]'] = array(
    array('checked' => FALSE),
  );

  if ($form['field_year_of_publication'][$language][0]['#required']) {
    $form['field_year_of_publication'][$language][0]['#title'] .= " " . theme('form_required_marker');
  }

  // Perform additional validation.
  $form['#validate'][] = 'gsb_feature_publication_ct_publication_node_form_validate';
}

/**
 *  Implements hook_field_group_pre_render_alter().
 */
function gsb_feature_publication_ct_field_group_pre_render_alter(&$element, $group, &$form) {
  // Hide field group for alumni name if alumni checkbox is not checked.
  if ($element['#id'] == 'node_publication_form_group_alumni_name') {
    $language = $form['language']['#value'];
    $element['#states']['invisible'][':input[name="field_alumni_story[' . $language . ']"]'] = array(
      array('checked' => FALSE),
    );
  }
}

/**
 * Validate callback for publication_node_form.
 *  - Conditionally validate alumni story fields.
 */
function gsb_feature_publication_ct_publication_node_form_validate($form, &$form_state) {
  $language = $form['language']['#value'];
  $values = $form_state['values'];

  // If Book is an alumni story we need to manually validate some required fields.
  if ($values['field_alumni_story'][$language][0]['value'] == TRUE) {

    // Validate first and last name.
    if (empty($values['field_first_name'][$language][0]['value'])) {
      $field_label = $form['field_first_name'][$language][0]['#title'];
      form_set_error('field_first_name][und][0][value', $field_label . ' field is required.');
    }
    if (empty($values['field_last_name'][$language][0]['value'])) {
      $field_label = $form['field_last_name'][$language][0]['#title'];
      form_set_error('field_last_name][und][0][value', $field_label . ' field is required.');
    }

    if (empty($values['field_program_single'][$language][0]['tid'])) {
      $field_label = $form['field_program_single'][$language]['#title'];
      form_set_error('field_program_single][und][0][tid', $field_label . ' field is required.');
    }

    if (empty($values['field_year'][$language][0]['value'])) {
      $field_label = $form['field_year'][$language]['#title'];
      form_set_error('field_year][und][0][value', $field_label . ' field is required.');
    }
  }
}

/**
 * Implements hook_gsb_feature_base_fields_faculty_author_types().
 */
function gsb_feature_publication_ct_gsb_feature_base_fields_faculty_author_types() {
  return array(
    'publication',
  );
}

/**
 * Update the publications academic area if not set with
 * the first author's academic area. 
 */
function _gsb_feature_publication_ct_update_academic_area() {

  // get list of all publications

  $query = db_select('node', 'node')
    ->fields('node')
    ->condition('type', 'publication')
    ->execute();
  $entities = $query->fetchAll();
  //dpm($entities);

  // loop thru list of pubs

  foreach ($entities as $info) {
    
    $nid = $info->nid;

    //////////////////////////////
    // testing notes
    /*
    pub0 - 
    node/326621/edit
    author = 302716 (Sun)
    no academic area set
    and... author has academic area = Marketing

    pub1 - What Theory is Not
    node/329206/edit
    author = 306471 (Sutton)
    no academic area set
    but... author has no academic area set

    pub2 - World Wealth Expanding
    node/329196/edit
    author = 302566 (Rowen)
    no academic area set
    and... author has academic area = Policial Economy

    pub3 - Intrafirm Bargaining Under Nonbinding Contracts
    node/329186/edit
    author = 302701 (Zwiebel)
    no academic area set
    and... author has academic area = Finance
    */

    //$nid = '326621'; // pub0 - works
    //$nid = '329206'; // pub1 - works
    //$nid = '329196'; // pub2 - works
    //$nid = '329186'; // pub3 - works
    //$nid = '337451'; // no author id
    dpm('pub node id = '.$nid);

    // load the publication node
    $pub_node = node_load($nid);
    //dpm($pub_node);

    //////////////////////////////
    // testing stuff
    //$ewrapper = entity_metadata_wrapper('node', $pub_node);
    //dpm(_wrapper_debug($ewrapper));

    // check if academic area is set
    // if academic area is not set
    // we will try to use the author's 
    // academic area
    if (empty($pub_node->field_academic_area_unlimited)) {

      // get the entity wrapper for the node

      $ewrapper = entity_metadata_wrapper('node', $pub_node);
      //dpm(_wrapper_debug($ewrapper));

      // get the authors info

      $authors = $ewrapper->field_authors->value();
      //dpm($authors);

      // get the first author nid

      if (!empty($authors)) {

        // get author's node id

        foreach ($authors as $author) {

          //dpm($author);

          if (!empty($author->field_person_fac_single_ref['und']) && !empty($author->field_person_fac_single_ref['und'][0]['target_id'])) {

            $author_nid = $author->field_person_fac_single_ref['und'][0]['target_id'];     
            //dpm($author_nid);

            // load the author node
            $author_node = node_load($author_nid);

            // update the publication with this author
            _gsb_feature_publication_ct_apply_author_academic_area($pub_node, $author_node);

            break; 

          }
        }

      }

    }

    //////////////////////////////
    // testing stuff
    //break;

  }

}

function _gsb_feature_publication_ct_apply_author_academic_area($pub_node, $author_node) {

  //dpm('in _gsb_feature_publication_ct_apply_author_academic_area');

  // get entity wrapper for publication node

  $ewrap_pub = entity_metadata_wrapper('node', $pub_node);
  //dpm(_wrapper_debug($ewrap_pub));

  // get entity wrapper for the author node

  $ewrap_author = entity_metadata_wrapper('node', $author_node);
  //dpm(_wrapper_debug($ewrap_author));  

  // get the term for the author's academic area

  $academic_area = $ewrap_author->field_academic_area_single->value();
  if ($academic_area != null) {
    // set the academic area term into the publication
    //dpm($academic_area);
    $ewrap_pub->field_academic_area_unlimited->set(array($academic_area));
    //dpm(_wrapper_debug($ewrap_pub)); 
    $ewrap_pub->save();
  }

}

//////////////////////////////
// testing stuff
/*
function _wrapper_debug($w) {
  $values = array();
  foreach ($w->getPropertyInfo() as $key => $val) {
    $values[$key] = $w->$key->value();
  }
  return $values;
}
*/
